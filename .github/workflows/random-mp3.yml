name: MusicBu Cloud Radio (random by duration)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [rotate]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: musicbu-radio
  cancel-in-progress: true

jobs:
  radio:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pick 1 random track from playlist
        id: pick
        shell: bash
        run: |
          set -euo pipefail
          FILE="playlist.txt"
          if [ ! -s "$FILE" ]; then
            echo "playlist.txt kh√¥ng t·ªìn t·∫°i ho·∫∑c r·ªóng."; exit 1
          fi

          # L·∫•y 1 d√≤ng ng·∫´u nhi√™n
          LINE=$(shuf -n 1 "$FILE")

          # C·∫Øt url | duration
          URL=$(echo "$LINE" | cut -d'|' -f1 | xargs)
          DUR_RAW=$(echo "$LINE" | cut -d'|' -f2 | xargs || true)

          # M·∫∑c ƒë·ªãnh 30 ph√∫t n·∫øu thi·∫øu duration
          if [ -z "${DUR_RAW:-}" ]; then DUR_RAW="30m"; fi

          # Chuy·ªÉn v·ªÅ gi√¢y (h, m, s)
          H=$(echo "$DUR_RAW" | grep -oE '[0-9]+h' | tr -d 'h' || true); H=${H:-0}
          M=$(echo "$DUR_RAW" | grep -oE '[0-9]+m' | tr -d 'm' || true); M=${M:-0}
          S=$(echo "$DUR_RAW" | grep -oE '[0-9]+s' | tr -d 's' || true); S=${S:-0}
          if [ "$H" = 0 ] && [ "$M" = 0 ] && [ "$S" = 0 ]; then
            # n·∫øu ng∆∞·ªùi d√πng ghi "1800" hay "120" th√¨ hi·ªÉu l√† gi√¢y
            if [[ "$DUR_RAW" =~ ^[0-9]+$ ]]; then S="$DUR_RAW"; else M=30; fi
          fi
          SECS=$(( H*3600 + M*60 + S ))
          if [ "$SECS" -lt 30 ]; then SECS=30; fi

          echo "url=$URL"      >> "$GITHUB_OUTPUT"
          echo "dur_str=$DUR_RAW" >> "$GITHUB_OUTPUT"
          echo "secs=$SECS"    >> "$GITHUB_OUTPUT"

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Build site (no large files, stream external URL)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p public
          URL='${{ steps.pick.outputs.url }}'
          DUR='${{ steps.pick.outputs.dur_str }}'

          cat > public/index.html <<HTML
          <!doctype html>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width,initial-scale=1">
          <title>üéß MusicBu Radio</title>
          <h1 style="font-family:system-ui; color:#58a6ff">üéß MusicBu Radio</h1>
          <p>Now playing:</p>
          <audio controls autoplay style="width:100%;max-width:720px">
            <source src="${URL}" type="audio/mpeg">
          </audio>
          <p>‚è± Duration: <b>${DUR}</b></p>
          <p><small>T·ª± random b√†i kh√°c khi h·∫øt th·ªùi l∆∞·ª£ng.</small></p>
          <style>
            body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#0d1117;color:#c9d1d9;padding:24px;max-width:900px;margin:auto}
            a{color:#58a6ff;text-decoration:none}
          </style>
          HTML

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4

      - name: Sleep until next track
        run: |
          echo "Ng·ªß ${{ steps.pick.outputs.secs }} gi√¢y‚Ä¶"
          sleep ${{ steps.pick.outputs.secs }}

      - name: Dispatch next run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          curl -sS -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO/dispatches \
            -d '{"event_type":"rotate"}'
          echo "ƒê√£ g·ªçi v√≤ng ti·∫øp theo."
