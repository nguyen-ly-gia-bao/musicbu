name: Radio MP3 (continuous by playlist duration)

on:
  # chạy tay bất cứ khi nào bạn muốn
  workflow_dispatch:
    inputs:
      max_hours:
        description: "Chạy liên tục tối đa bao nhiêu giờ (tối đa ~6h)"
        required: false
        default: "6"
      default_duration:
        description: "Thời lượng mặc định (giây) nếu dòng playlist không có |duration"
        required: false
        default: "180"
      min_sleep:
        description: "Thời gian ngủ tối thiểu giữa các lần deploy (giây)"
        required: false
        default: "30"
  # nếu muốn tự khởi động theo lịch, mở comment dòng dưới và chỉnh cron
  # schedule:
  #   - cron: "0 * * * *"   # khởi động mỗi giờ

permissions:
  contents: write   # cần quyền push lên nhánh gh-pages

jobs:
  radio:
    runs-on: ubuntu-latest
    timeout-minutes: 360   # tối đa 6 tiếng
    env:
      REPO: ${{ github.repository }}
      TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare helpers
        shell: bash
        run: |
          set -euo pipefail
          cat > rotate_once.sh <<'BASH'
          #!/usr/bin/env bash
          set -euo pipefail

          PLAYLIST="playlist.txt"
          [ ! -f "$PLAYLIST" ] && echo "playlist.txt not found!" && exit 1

          # Bỏ dòng trống, random 1 dòng
          mapfile -t LINES < <(grep -ve '^[[:space:]]*$' "$PLAYLIST")
          CNT=${#LINES[@]}
          [ "$CNT" -lt 1 ] && echo "playlist is empty" && exit 1
          IDX=$(( RANDOM % CNT ))
          LINE="${LINES[$IDX]}"

          URL="$(echo "$LINE" | cut -d'|' -f1 | xargs)"
          DUR_RAW="$(echo "$LINE" | cut -d'|' -f2 | xargs || true)"

          # parse 1h41m27s / 41m43s / 90s / 12m / 2h / or plain seconds
          to_seconds () {
            local STR="$1"
            [ -z "$STR" ] && echo "${DEFAULT_DURATION}" && retu_
