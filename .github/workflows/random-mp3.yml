name: MusicBu Radio Infinite (fixed)

on:
  workflow_dispatch:

jobs:
  radio:
    runs-on: ubuntu-latest
    timeout-minutes: 4320  # cháº¡y tá»‘i Ä‘a 3 ngÃ y liÃªn tá»¥c

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start Radio
        run: |
          FILE="playlist.txt"
          if [ ! -f "$FILE" ]; then
            echo "playlist.txt not found!"
            exit 1
          fi

          mkdir -p public/f

          echo "ğŸ§ MusicBu Radio started"
          while true; do
            echo "ğŸ² Chá»n ngáº«u nhiÃªn 1 bÃ i..."
            TOTAL=$(grep -c . "$FILE")
            LINE=$(shuf -n 1 "$FILE")

            URL=$(echo "$LINE" | cut -d'|' -f1 | xargs)
            DUR=$(echo "$LINE" | cut -d'|' -f2 | xargs)

            if [ -z "$DUR" ]; then
              DUR="30m"
            fi

            # chuyá»ƒn thá»i lÆ°á»£ng thÃ nh giÃ¢y
            H=$(echo $DUR | grep -oE '[0-9]+h' | tr -d 'h')
            M=$(echo $DUR | grep -oE '[0-9]+m' | tr -d 'm')
            S=$(echo $DUR | grep -oE '[0-9]+s' | tr -d 's')
            H=${H:-0}; M=${M:-0}; S=${S:-0}
            SECS=$((H*3600 + M*60 + S))

            echo "ğŸµ PhÃ¡t bÃ i: $URL (â± $DUR = $SECS giÃ¢y)"

            cat > public/index.html <<HTML
            <!DOCTYPE html>
            <html><meta charset="utf-8">
            <body style="background:#0d1117;color:#c9d1d9;text-align:center;font-family:Segoe UI,Roboto,Arial">
            <h2>ğŸ§ MusicBu Radio</h2>
            <p>Äang phÃ¡t:</p>
            <audio controls autoplay style="width:80%;margin-top:10px;border-radius:12px">
              <source src="$URL" type="audio/mpeg">
            </audio>
            <p>â± Thá»i lÆ°á»£ng: <b>$DUR</b></p>
            <p><small>Tá»± Ä‘á»™ng Ä‘á»•i bÃ i khi háº¿t thá»i lÆ°á»£ng.</small></p>
            </body></html>
            HTML

            git config user.name "MusicBu Bot"
            git config user.email "bot@github.com"
            git add public/index.html
            git commit -m "ğŸµ Now playing: $URL ($DUR)" || true
            git push origin main

            echo "â³ Ngá»§ $SECS giÃ¢y Ä‘á»ƒ phÃ¡t xong bÃ i..."
            sleep $SECS
          done
